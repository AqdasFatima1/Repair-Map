<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Repair Map NYC</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- GeoSearch CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.7.0/dist/geosearch.css" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Arial', sans-serif; /* Changed to a clean, modern font */
    }

    #map {
      height: 100vh;
      width: 100%;
      border-radius: 15px; /* More rounded feel for the map */
    }

    .leaflet-control-layers {
      background: white;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px; /* Rounded layer control */
    }

    .leaflet-control-layers label {
      font-size: 14px;
    }

    .custom-popup input, .custom-popup textarea, .custom-popup select {
      width: 100%;
      margin-top: 8px;
      margin-bottom: 12px;
      border-radius: 6px; /* Rounded form fields */
      padding: 8px;
      font-size: 14px;
    }

    .custom-popup button {
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 6px; /* Rounded button */
      background-color: #4B8D7D; /* Subtle color */
      color: white;
      border: none;
    }

    .custom-popup button:hover {
      background-color: #3e755e;
    }

    .custom-icon {
      background-color: #4B8D7D; /* Consistent with map's color palette */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: block;
    }

    .leaflet-bar a {
      border-radius: 50%; /* Rounded control icons */
    }

    .leaflet-geosearch-input {
      border-radius: 8px; /* Rounded search bar */
      font-size: 16px;
    }

    .leaflet-geosearch-bar {
      border-radius: 10px; /* Rounded search bar container */
    }

    /* Style for the map tiles */
    .leaflet-tile {
      filter: saturate(80%); /* Muted, professional color palette */
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Firebase & Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Leaflet & GeoSearch -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch@3.7.0/dist/bundle.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiKzc8OGzf3X-AfQbHk6bI6SoKtPvcq2E",
      authDomain: "repair-map-50701.firebaseapp.com",
      projectId: "repair-map-50701",
      storageBucket: "repair-map-50701.appspot.com",
      messagingSenderId: "42233664095",
      appId: "1:42233664095:web:da8ddb442169ed06f8c1ea",
      measurementId: "G-11VNZY8QLX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map('map').setView([40.7128, -74.0060], 11);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors & CartoDB',
      maxZoom: 19
    }).addTo(map);

    // GeoSearch Control
    window.addEventListener('load', function () {
      if (typeof GeoSearch !== 'undefined' && GeoSearch.OpenStreetMapProvider) {
        const provider = new GeoSearch.OpenStreetMapProvider();
        const searchControl = new GeoSearch.GeoSearchControl({
          provider: provider,
          style: 'bar',
          showMarker: true,
          retainZoomLevel: false,
          autoClose: true,
          searchLabel: 'Search for a place'
        });
        map.addControl(searchControl);
      } else {
        console.error("GeoSearch or OpenStreetMapProvider is not loaded correctly");
      }
    });

    const repairLayer = L.layerGroup().addTo(map);
    const needsRepairLayer = L.layerGroup().addTo(map);

    const layers = {
      "Where People Go for Repairs": repairLayer,
      "Infrastructure Needing Repair": needsRepairLayer
    };

    L.control.layers(null, layers, { position: 'topright', collapsed: false }).addTo(map);

    const customIcon = new L.DivIcon({
      className: 'custom-icon',
      iconSize: [20, 20]
    });

    map.on('click', function (e) {
      const markerId = `marker-${Date.now()}`;
      const popupContent = document.createElement('div');
      popupContent.className = 'custom-popup';
      popupContent.innerHTML = `
        <label>Title:<br><input type="text" id="${markerId}-title"></label><br>
        <label>Description:<br><textarea id="${markerId}-desc"></textarea></label><br>
        <label>Image URL:<br><input type="text" id="${markerId}-img"></label><br>
        <label>
          Layer:<br>
          <select id="${markerId}-layer">
            <option value="repair">Where People Go for Repairs</option>
            <option value="needs">Infrastructure Needing Repair</option>
          </select>
        </label><br>
        <button id="${markerId}-save">Save</button>
      `;

      const popup = L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(map);

      document.getElementById(`${markerId}-save`).addEventListener('click', () => {
        saveMarker(e.latlng, markerId);
      });
    });

    function sanitizeURL(url) {
      try {
        const parsed = new URL(url);
        return ['http:', 'https:'].includes(parsed.protocol) ? parsed.href : '';
      } catch {
        return '';
      }
    }

    function saveMarker(latlng, markerId) {
      const title = document.getElementById(`${markerId}-title`).value.trim();
      const desc = document.getElementById(`${markerId}-desc`).value.trim();
      const img = document.getElementById(`${markerId}-img`).value.trim();
      const layerType = document.getElementById(`${markerId}-layer`).value;

      if (!title) return alert("Title is required");

      const data = {
        lat: latlng.lat,
        lng: latlng.lng,
        title,
        desc,
        img,
        type: layerType
      };

      db.collection("markers").add(data).then(() => {
        addMarkerToMap(data);
        map.closePopup();
      });
    }

    function addMarkerToMap(data) {
      const safeImg = sanitizeURL(data.img);
      const content = `<strong>${data.title}</strong><br>${data.desc}${safeImg ? `<br><img src="${safeImg}" width="200">` : ''}`;
      const marker = L.marker([data.lat, data.lng], { icon: customIcon }).bindPopup(content);

      if (data.type === 'repair') {
        repairLayer.addLayer(marker);
      } else {
        needsRepairLayer.addLayer(marker);
      }
    }

    db.collection("markers").get().then(querySnapshot => {
      querySnapshot.forEach(doc => {
        addMarkerToMap(doc.data());
      });
    });

    // Load borough boundaries GeoJSON
    map.whenReady(() => {
      fetch('boroughs.geojson')
        .then(res => res.json())
        .then(data => {
          L.geoJSON(data, {
            style: {
              color: '#4B8D7D', /* Subtle green for borough boundaries */
              weight: 2,
              fillOpacity: 0.1
            }
          }).addTo(map);
        }).catch(err => console.error("GeoJSON load error:", err));
    });
  </script>
</body>
</html>
